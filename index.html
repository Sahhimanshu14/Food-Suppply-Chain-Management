<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Supply Chain Management Platform</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f7b57, #12b9aa, #c2a978);
            --card-bg: rgba(255, 255, 255, 0.95);
            --surface: #ffffff;
            --text-primary: #1b1d1f;
            --text-secondary: #4a4e56;
            --accent-primary: #0f7b57;
            --accent-secondary: #12b9aa;
            --accent-earth: #c2a978;
            --shadow-soft: 0 18px 40px rgba(15, 40, 60, 0.18);
            --shadow-card: 0 14px 30px rgba(18, 40, 55, 0.14);
            --radius-lg: 32px;
            --radius-md: 20px;
            --radius-sm: 14px;
            --transition: 300ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            color: var(--text-primary);
            background: #f4f7f8;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Slide-in Menu */
        .side-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 300px;
            height: 100%;
            background: var(--surface);
            box-shadow: var(--shadow-soft);
            z-index: 1000;
            transition: left var(--transition);
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .side-menu.open {
            left: 0;
        }

        .side-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .side-menu-header .brand {
             display: flex;
             align-items: center;
             gap: 12px;
        }
        
        .side-menu-header .logo {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            background: var(--accent-primary);
            color: #fff;
            display: grid;
            place-items: center;
            font-weight: 700;
        }
        
        .side-menu-header .brand-name {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-menu-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 2rem;
            color: var(--text-secondary);
        }

        .search-bar {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-bar input {
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: var(--radius-sm);
            border: 1px solid #ddd;
            font-size: 1rem;
        }
        
        /* New Nav Item Style for Help/Info */
        .side-menu-nav {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .nav-item {
            display: block;
            width: 100%;
            padding: 0.8rem 1rem;
            background: none;
            border: none;
            text-align: left;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background 150ms;
        }
        
        .nav-item:hover {
            background: #f0f4f8;
            color: var(--accent-primary);
        }

        /* --- New Auth Page Styles --- */
        #auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 90vh;
            padding: 2rem;
            background: var(--bg-gradient);
        }

        .auth-page {
            width: 100%;
            max-width: 450px;
            background: var(--surface);
            padding: 2.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-soft);
        }

        .auth-page h2 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 1.5rem;
            color: var(--accent-primary);
        }

        .auth-form .form-group {
            margin-bottom: 1rem;
        }

        .auth-form .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .auth-form .form-group input,
        .auth-form .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ccc;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-family: var(--font-family);
        }

        .auth-form .auth-button {
            width: 100%;
            padding: 0.9rem;
            margin-top: 1rem;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 1.1rem;
            font-weight: 700;
            background: var(--accent-primary);
            color: white;
            cursor: pointer;
            transition: background var(--transition);
        }

        .auth-form .auth-button:hover {
            background: #0d6a4a;
        }

        .auth-switch-link {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.95rem;
        }

        .auth-switch-link span {
            color: var(--text-secondary);
        }

        .auth-switch-link a {
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .auth-error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            text-align: center;
            margin-top: 1rem;
            display: none; /* Hidden by default */
        }
        
        /* --- Side Menu Auth Links --- */
        .side-menu-auth {
            margin-top: auto; /* Push to the bottom when other elements are few */
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        
        .side-menu-auth button {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: var(--radius-sm);
            border: 1px solid #ccc;
            font-size: 1rem;
            cursor: pointer;
            background: var(--accent-primary);
            color: white;
            transition: background var(--transition);
        }
        .side-menu-auth button:hover {
            background: #0d6a4a;
        }
        .side-menu-auth button.secondary {
            background: var(--surface);
            color: var(--accent-primary);
            border: 1px solid var(--accent-primary);
        }
         .side-menu-auth button.secondary:hover {
             background: #f0f4f8;
         }

        .user-info {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .user-info p {
             margin-bottom: 0.5rem;
        }

        .user-info #logout-btn {
            width: 100%;
            padding: 0.8rem;
            margin-top: 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            background: #e74c3c;
            color: white;
            border: none;
            cursor: pointer;
        }
        .user-info #logout-btn:hover {
             background: #c0392b;
        }

        .top-header {
            position: sticky;
            top: 0;
            z-index: 999;
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: blur(14px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px clamp(24px, 4vw, 60px);
            border-bottom: 1px solid rgba(18, 40, 55, 0.08);
        }

        .mobile-nav-toggle {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 36px;
            height: 28px;
            background: transparent;
            border: none;
            padding: 4px;
            cursor: pointer;
        }

        .mobile-nav-toggle span {
            display: block;
            height: 4px;
            border-radius: 999px;
            background: var(--text-primary);
            transition: transform var(--transition), opacity var(--transition);
        }
        
        .brand {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .logo {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            background: var(--accent-primary);
            color: #fff;
            display: grid;
            place-items: center;
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 1px;
            box-shadow: var(--shadow-soft);
        }

        .brand-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .main-nav {
            display: none; /* Replaced by side menu */
        }
        
        .dashboard-view {
            padding: clamp(30px, 5vw, 60px) clamp(24px, 5vw, 110px);
            min-height: 80vh;
        }

        .dashboard-header {
            margin-bottom: 2rem;
        }

        .dashboard-header h2 {
            font-size: clamp(2rem, 3vw, 2.8rem);
            margin-bottom: 0.5rem;
        }

        .dashboard-header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }
        
        .product-form {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-card);
            margin-bottom: 2rem;
        }
        
        .product-form h3 {
            margin-bottom: 1.5rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .form-grid input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ccc;
            border-radius: var(--radius-sm);
            font-family: var(--font-family);
        }

        .product-form button {
            margin-top: 1rem;
            padding: 0.8rem 1.5rem;
            background: var(--accent-secondary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .product-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-card);
            padding: 1.5rem;
            transition: transform var(--transition), box-shadow var(--transition);
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-soft);
        }

        .product-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .product-card h4 {
            font-size: 1.3rem;
        }

        .product-card .status {
             padding: 6px 14px;
             border-radius: 999px;
             font-size: 0.8rem;
             font-weight: 600;
             letter-spacing: 0.4px;
        }
         .status-harvested { background: rgba(194, 169, 120, 0.2); color: #9b6f27;}
        .status-in-transit { background: rgba(52, 152, 219, 0.2); color: #2980b9;}
        .status-at-retailer { background: rgba(230, 126, 34, 0.2); color: #d35400;}
        .status-sold { background: rgba(46, 204, 113, 0.2); color: #27ae60;}
        .status-processed { background: rgba(142, 68, 173, 0.2); color: #8e44ad;}


        .product-card p {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            word-break: break-all; /* Ensure long IDs wrap */
        }
        
        .product-card p strong {
            color: var(--text-primary);
        }

        /* QR CODE STYLES */
        .card-qr-container {
            text-align: center;
            margin: 1rem 0 0.5rem 0;
        }
        
        .card-qr-container canvas {
            border-radius: var(--radius-sm);
            border: 4px solid var(--surface);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        /* ACTIONS */
        .product-actions button, .scan-btn {
            margin-top: 1rem;
            padding: 0.6rem 1rem;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            margin-right: 0.5rem; /* Add some spacing between buttons */
            font-weight: 600;
        }
        
        .scan-btn {
            background: var(--accent-earth);
        }

        .hidden {
            display: none !important;
        }
        
        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1001;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition), visibility var(--transition);
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-md);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform var(--transition);
        }
        
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .modal-header h3 {
            font-size: 1.5rem;
        }

        #close-modal, #close-help-modal, #close-info-modal {
            font-size: 2rem;
            background: none;
            border: none;
            cursor: pointer;
        }

        .tracking-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        @media (min-width: 768px) {
            .tracking-layout {
                 grid-template-columns: 1fr 1fr;
            }
        }
        
        #map {
            height: 350px; 
            width: 100%;
            border-radius: var(--radius-sm);
            background-color: #eee;
            border: 1px solid #ddd;
        }
        
        .tracking-details h4 {
            margin-bottom: 1rem;
        }
        
        .tracking-details h5 {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .timeline {
            list-style: none;
            padding: 0;
        }

        .timeline-item {
            position: relative;
            padding-left: 30px;
            padding-bottom: 1.5rem;
            border-left: 2px solid #ddd;
        }

        .timeline-item:last-child {
            border-left: 2px solid transparent; 
            padding-bottom: 0.5rem;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -9px;
            top: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-secondary);
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--accent-secondary);
        }
        
        .timeline-item p {
            margin: 0;
            color: var(--text-primary);
            font-weight: 600;
        }
        .timeline-item span {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: block;
        }

        .qr-code-container {
            margin-top: 1rem;
            text-align: center;
        }

        .qr-code-container canvas {
            border: 5px solid white;
            box-shadow: var(--shadow-card);
            border-radius: var(--radius-sm);
        }
        
        /* Truck Icon CSS for Leaflet Marker */
        .truck-icon {
            background: var(--accent-primary);
            color: white;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            text-align: center;
            line-height: 26px; 
        }


        /* Original styles for sections */
        .hero-section {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: clamp(24px, 4vw, 60px);
          padding: clamp(60px, 8vw, 120px) clamp(24px, 5vw, 120px);
          background: var(--bg-gradient);
          color: #fff;
          border-radius: 0 0 var(--radius-lg) var(--radius-lg);
          box-shadow: var(--shadow-soft);
        }

        .hero-content h1 {
          font-size: clamp(2.5rem, 4vw, 3.8rem);
          line-height: 1.1;
          margin-bottom: 18px;
        }

        .hero-content p {
          font-size: clamp(1.1rem, 2.5vw, 1.3rem);
          margin-bottom: 30px;
          color: rgba(255, 255, 255, 0.82);
        }

        .hero-visual {
          display: grid;
          gap: 20px;
          align-content: start;
        }

        .hero-badge {
          background: rgba(255, 255, 255, 0.18);
          border: 1px solid rgba(255, 255, 255, 0.24);
          padding: 12px 18px;
          border-radius: var(--radius-sm);
          font-weight: 500;
          letter-spacing: 0.4px;
          text-transform: uppercase;
          font-size: 0.88rem;
          backdrop-filter: blur(12px);
        }

        .hero-stats {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
          gap: 16px;
        }

        .stat-card {
          background: rgba(255, 255, 255, 0.18);
          border-radius: var(--radius-sm);
          padding: 18px;
          box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.18);
        }

        .stat-card h3 {
          font-size: 1.6rem;
          font-weight: 700;
        }

        .stat-card span {
          font-size: 0.85rem;
          color: rgba(255, 255, 255, 0.75);
        }
        
        .site-footer {
          text-align: center;
          padding: 28px 18px;
          color: rgba(27, 29, 31, 0.72);
          font-size: 0.95rem;
          border-top: 1px solid rgba(18, 40, 55, 0.08);
          margin-top: 2rem;
        }

    </style>
</head>
<body>

    <aside class="side-menu" id="side-menu">
        <div class="side-menu-header">
             <div class="brand">
                 <div class="logo">FS</div>
                 <span class="brand-name">Food Supply</span>
             </div>
            <button class="close-menu-btn" id="close-menu-btn">&times;</button>
        </div>
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Search Batches...">
        </div>
        
        <!-- NEW: User Directory and Help Navigation -->
        <nav class="side-menu-nav">
            <button class="nav-item" id="open-info-modal">User Directory</button>
            <button class="nav-item" id="open-help-modal">Help & Support</button>
        </nav>
        
        <!-- Auth Section in Side Menu -->
        <div class="side-menu-auth" id="side-menu-auth-links">
            <button id="side-menu-login-btn">Login</button>
            <button id="side-menu-register-btn" class="secondary">Register</button>
        </div>
        
        <div class="user-info hidden" id="user-info">
            <p>Welcome, <strong id="user-name"></strong>!</p>
            <p>Role: <strong id="user-role"></strong></p>
            <button id="logout-btn">Logout</button>
        </div>
    </aside>

    <header class="top-header" id="top-header">
        <button class="mobile-nav-toggle" id="open-menu-btn" aria-label="Toggle navigation">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="brand">
            <div class="logo">FS</div>
            <span class="brand-name">Food Supply Chain</span>
        </div>
    </header>

    <!-- New Auth Container -->
    <div id="auth-container">
        <!-- Login Page -->
        <div id="login-page" class="auth-page">
            <h2>Login</h2>
            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <p id="login-error" class="auth-error-message">Invalid email or password.</p>
                <button type="submit" class="auth-button">Login</button>
            </form>
            <p class="auth-switch-link">
                <span>Don't have an account?</span>
                <a id="go-to-register-link">Register</a>
            </p>
        </div>

        <!-- Register Page -->
        <div id="register-page" class="auth-page hidden">
            <h2>Register</h2>
            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <label for="register-role">I am a:</label>
                    <select id="register-role">
                        <option value="consumer">Consumer</option>
                        <option value="farmer">Farmer</option>
                        <option value="processor">Processor</option>
                        <option value="retailer">Retailer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="register-name">Full Name</label>
                    <input type="text" id="register-name" required>
                </div>
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" required>
                </div>
                <div class="form-group">
                    <label for="register-contact">Contact No.</label>
                    <input type="tel" id="register-contact" required>
                </div>
                <p id="register-error" class="auth-error-message">This email is already registered.</p>
                <button type="submit" class="auth-button">Register</button>
            </form>
            <p class="auth-switch-link">
                <span>Already have an account?</span>
                <a id="go-to-login-link">Login</a>
            </p>
        </div>
    </div>

    <!-- Main Dashboard Container (hidden by default) -->
    <div id="main-container" class="hidden">
        <main>
            <div id="consumer-dashboard" class="dashboard-view">
                <section class="hero-section">
                    <div class="hero-content">
                        <h1>Trace Your Food Journey</h1>
                        <p>Farm â†’ Processor â†’ Retailer â†’ You</p>
                    </div>
                    <div class="hero-visual">
                        <div class="hero-badge">Trusted by Farms & Retailers</div>
                        <div class="hero-stats">
                            <div class="stat-card">
                                <h3>650+</h3>
                                <span>Tracked Batches</span>
                            </div>
                            <div class="stat-card">
                                <h3>98%</h3>
                                <span>On-time Deliveries</span>
                            </div>
                            <div class="stat-card">
                                <h3>24/7</h3>
                                <span>Monitoring</span>
                            </div>
                        </div>
                    </div>
                </section>
                <div class="dashboard-header" style="margin-top: 3rem;">
                    <h2>All Products</h2>
                    <p>Scan a product's QR code or click "View Journey" to see its full details.</p>
                </div>
                <div id="consumer-product-list" class="product-list">
                    <!-- Product cards will be injected here -->
                </div>
            </div>

            <div id="farmer-dashboard" class="dashboard-view hidden">
                <div class="dashboard-header">
                    <h2>Farmer Dashboard</h2>
                    <p>Manage your produce batches from harvest to shipment.</p>
                </div>
                <div class="product-form">
                    <h3>Add New Product Batch</h3>
                    <form id="add-product-form">
                        <div class="form-grid">
                            <input type="text" id="product-name" placeholder="Product Name (e.g., Organic Apples)" required>
                            <input type="number" id="product-quantity" placeholder="Quantity (kg)" required>
                            <input type="date" id="harvest-date" required>
                        </div>
                        <button type="submit">Add Batch</button>
                    </form>
                </div>
                <h3>Your Batches</h3>
                <div id="farmer-product-list" class="product-list"></div>
            </div>

            <div id="processor-dashboard" class="dashboard-view hidden">
                <div class="dashboard-header">
                    <h2>Processor Dashboard</h2>
                    <p>Track and manage incoming and outgoing batches.</p>
                </div>
                <h3>Batches to Process</h3>
                <div id="processor-product-list" class="product-list"></div>
            </div>

            <div id="retailer-dashboard" class="dashboard-view hidden">
                <div class="dashboard-header">
                    <h2>Retailer Dashboard</h2>
                    <p>Manage inventory and track product origins.</p>
                </div>
                <h3>Store Inventory</h3>
                <div id="retailer-product-list" class="product-list"></div>
            </div>
            
        </main>
        
        <footer class="site-footer">
            <p>Â© <span id="currentYear"></span> Food Supply Chain Management Platform</p>
        </footer>
    </div>

    <!-- Tracking Modal -->
    <div class="modal-overlay" id="tracking-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Product Journey</h3>
                <button id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tracking-layout">
                    <div class="map-container">
                         <h4>Live Tracking</h4>
                         <!-- Leaflet Map Container -->
                         <div id="map"></div>
                    </div>
                    <div class="tracking-details">
                        <h4>Timeline</h4>
                        <ul id="tracking-timeline" class="timeline"></ul>
                        
                        <h5>Scan to Track</h5>
                        <div id="modal-qr-code" class="qr-code-container">
                            <!-- QR Code will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Desk Modal -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="help-modal-title">Help & Support</h3>
                <button id="close-help-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                    If you require assistance with tracking a batch, reporting an issue, or general inquiries, please contact our help desk via the options below.
                </p>
                
                <div class="help-desk-options" style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Email Option (Uses mailto: protocol) -->
                    <div style="padding: 1rem; border: 1px solid #ddd; border-radius: 12px; background: #f9f9f9;">
                        <h5 style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-primary);">Contact via Email</h5>
                        <p style="font-size: 1.1rem;">
                            <a href="mailto:sahhimanshu467@gmail.com" style="color: #3498db; text-decoration: none; font-weight: 500;">sahhimanshu467@gmail.com</a>
                        </p>
                    </div>

                    <!-- Phone Option (Uses tel: protocol) -->
                    <div style="padding: 1rem; border: 1px solid #ddd; border-radius: 12px; background: #f9f9f9;">
                        <h5 style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-primary);">Contact via Phone</h5>
                        <p style="font-size: 1.1rem;">
                            <a href="tel:9341771702" style="color: #3498db; text-decoration: none; font-weight: 500;">9341771702</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: User Information Modal -->
    <div class="modal-overlay" id="info-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="info-modal-title">User Directory & Contact Information</h3>
                <button id="close-info-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                    Connect directly with other users in the supply chain (Farmers, Processors, Retailers, and Consumers).
                </p>
                <div id="user-directory-list" style="display: grid; gap: 1rem;">
                    <!-- User cards will be injected here by JavaScript -->
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <!-- Leaflet JS Library for Mapping -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- MOCK BACKEND & DATA ---
            
            // MOCK_USERS holds user data for login and the new User Directory
            let MOCK_USERS = [
                { id: 'f1', name: 'Farmer User 1', role: 'farmer', email: 'farmer@test.com', password: '123', contact: '9998887771' },
                { id: 'd1', name: 'Processor User 1', role: 'processor', email: 'dist@test.com', password: '123', contact: '9998887772' },
                { id: 'r1', name: 'Retailer User 1', role: 'retailer', email: 'retail@test.com', password: '123', contact: '9998887773' },
                { id: 'c1', name: 'Consumer User 1', role: 'consumer', email: 'consumer@test.com', password: '123', contact: '9998887774' },
            ];
            
            // Location constants
            const LOCATIONS = {
                MUMBAI_FARM: { lat: 19.0760, lng: 72.8777, name: "Mumbai Farm" },
                PUNE_HUB: { lat: 18.5204, lng: 73.8567, name: "Pune Processing Hub" },
                BANGALORE_RETAIL: { lat: 12.9716, lng: 77.5946, name: "Bangalore Retail Store" },
                DELHI_HUB: { lat: 28.7041, lng: 77.1025, name: "Delhi Distribution" }
            };

            let productBatches = [
                {
                    id: `batch-1672531200000`, 
                    farmerId: 'f1', 
                    name: 'Organic Tomatoes',
                    quantity: 200,
                    status: 'sold',
                    history: [
                        { status: 'Harvested', by: 'Farmer User 1 (farmer)', timestamp: new Date('2025-10-26T08:00:00Z').toISOString(), location: LOCATIONS.MUMBAI_FARM },
                        { status: 'Processed', by: 'Processor User 1 (processor)', timestamp: new Date('2025-10-26T14:00:00Z').toISOString(), location: LOCATIONS.PUNE_HUB },
                        { status: 'Received by Retailer', by: 'Retailer User 1 (retailer)', timestamp: new Date('2025-10-27T09:00:00Z').toISOString(), location: LOCATIONS.BANGALORE_RETAIL },
                        { status: 'Sold', by: 'Consumer User 1 (consumer)', timestamp: new Date('2025-10-28T18:30:00Z').toISOString(), location: LOCATIONS.BANGALORE_RETAIL }
                    ]
                },
                {
                    id: `batch-1678886400000`, 
                    farmerId: 'f1', 
                    name: 'Fresh Strawberries',
                    quantity: 150,
                    status: 'in-transit', 
                    history: [
                        { status: 'Harvested', by: 'Farmer User 1 (farmer)', timestamp: new Date('2025-11-13T10:00:00Z').toISOString(), location: LOCATIONS.MUMBAI_FARM },
                        { status: 'Processed', by: 'Processor User 1 (processor)', timestamp: new Date('2025-11-14T08:00:00Z').toISOString(), location: LOCATIONS.PUNE_HUB }
                    ],
                    destination: LOCATIONS.BANGALORE_RETAIL
                }
            ];
            
            let currentUser = null;
            
            // --- Map & Tracking Variables ---
            let map;
            let liveMarker;
            let historicalPolyline;
            let historicalMarkers = []; 
            let liveTrackingInterval = null;
            
            const truckIcon = L.divIcon({
                className: 'truck-icon',
                html: 'ðŸšš',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            // --- Map Utility Functions ---
            
            const initMap = () => {
                 if (!map) {
                    map = L.map('map');
                     L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);
                }
            }

            const clearMapLayers = () => {
                if (liveTrackingInterval) {
                    clearInterval(liveTrackingInterval);
                    liveTrackingInterval = null;
                }
                if (liveMarker) {
                    liveMarker.remove();
                    liveMarker = null;
                }
                if (historicalPolyline) {
                    historicalPolyline.remove();
                    historicalPolyline = null;
                }
                historicalMarkers.forEach(marker => marker.remove());
                historicalMarkers = [];
            }
            
            // --- DOM ELEMENTS ---
            const openMenuBtn = document.getElementById('open-menu-btn');
            const closeMenuBtn = document.getElementById('close-menu-btn');
            const sideMenu = document.getElementById('side-menu');
            const searchInput = document.getElementById('search-input');
            const topHeader = document.getElementById('top-header');

            // --- Auth Elements ---
            const authContainer = document.getElementById('auth-container');
            const mainContainer = document.getElementById('main-container');
            const loginPage = document.getElementById('login-page');
            const registerPage = document.getElementById('register-page');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginError = document.getElementById('login-error');
            const registerError = document.getElementById('register-error');
            const goToRegisterLink = document.getElementById('go-to-register-link');
            const goToLoginLink = document.getElementById('go-to-login-link');
            
            // --- Side Menu Auth Elements ---
            const sideMenuAuthLinks = document.getElementById('side-menu-auth-links');
            const sideMenuLoginBtn = document.getElementById('side-menu-login-btn');
            const sideMenuRegisterBtn = document.getElementById('side-menu-register-btn');
            const userInfo = document.getElementById('user-info');
            const logoutBtn = document.getElementById('logout-btn');

            // --- Dashboard Elements ---
            const dashboards = {
                consumer: document.getElementById('consumer-dashboard'),
                farmer: document.getElementById('farmer-dashboard'),
                processor: document.getElementById('processor-dashboard'),
                retailer: document.getElementById('retailer-dashboard'),
            };

            const productLists = {
                consumer: document.getElementById('consumer-product-list'),
                farmer: document.getElementById('farmer-product-list'),
                processor: document.getElementById('processor-product-list'),
                retailer: document.getElementById('retailer-product-list'),
            };

            const addProductForm = document.getElementById('add-product-form');
            
            // --- Modal Elements ---
            const trackingModal = document.getElementById('tracking-modal');
            const closeModalBtn = document.getElementById('close-modal');
            const modalQrCodeContainer = document.getElementById('modal-qr-code');
            const trackingTimeline = document.getElementById('tracking-timeline');
            const modalTitle = document.getElementById('modal-title');
            
            // --- Help Desk Elements ---
            const helpModal = document.getElementById('help-modal');
            const openHelpModalBtn = document.getElementById('open-help-modal');
            const closeHelpModalBtn = document.getElementById('close-help-modal');

            // --- NEW Info Modal Elements ---
            const infoModal = document.getElementById('info-modal');
            const openInfoModalBtn = document.getElementById('open-info-modal');
            const closeInfoModalBtn = document.getElementById('close-info-modal');
            const userDirectoryList = document.getElementById('user-directory-list');
            
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            // --- APP LOGIC ---

            const init = () => {
                bindEventListeners();
                updateUIForLogout(); // Start in logged-out state
                showPage('login'); // Show login page by default
            };
            
            // --- Auth & Page Functions ---
            
            const showPage = (pageName) => {
                // Hide all main containers
                authContainer.classList.add('hidden');
                mainContainer.classList.add('hidden');
                topHeader.classList.add('hidden');
                
                // Hide auth sub-pages
                loginPage.classList.add('hidden');
                registerPage.classList.add('hidden');

                if (pageName === 'login') {
                    authContainer.classList.remove('hidden');
                    loginPage.classList.remove('hidden');
                } else if (pageName === 'register') {
                    authContainer.classList.remove('hidden');
                    registerPage.classList.remove('hidden');
                } else if (pageName === 'dashboard') {
                    mainContainer.classList.remove('hidden');
                    topHeader.classList.remove('hidden');
                }
            };
            
            const handleLogin = (e) => {
                e.preventDefault();
                loginError.style.display = 'none';
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                const user = MOCK_USERS.find(u => u.email === email && u.password === password);
                
                if (user) {
                    currentUser = user;
                    updateUIForLogin();
                    showPage('dashboard');
                    loginForm.reset();
                } else {
                    loginError.style.display = 'block';
                }
            };

            const handleRegister = (e) => {
                e.preventDefault();
                registerError.style.display = 'none';
                
                const role = document.getElementById('register-role').value;
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const contact = document.getElementById('register-contact').value;
                
                const existingUser = MOCK_USERS.find(u => u.email === email);
                
                if (existingUser) {
                    registerError.style.display = 'block';
                    return;
                }
                
                const newUser = {
                    id: `user-${new Date().getTime()}`,
                    role, name, email, password, contact
                };
                
                MOCK_USERS.push(newUser);
                console.log('Registered new user:', newUser);
                registerForm.reset();
                showPage('login'); // Go to login page after successful registration
            };
            
            const handleLogout = () => {
                currentUser = null;
                updateUIForLogout();
                showPage('login');
            };

            const updateUIForLogin = () => {
                // Update side menu
                sideMenuAuthLinks.classList.add('hidden');
                userInfo.classList.remove('hidden');
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('user-role').textContent = currentUser.role;
                sideMenu.classList.remove('open');
                
                // Set correct dashboard view
                switchView(currentUser.role);
                renderAllDashboards();
                
                // Check for URL hash now that user is logged in
                checkUrlHash();
            };

            const updateUIForLogout = () => {
                // Update side menu
                sideMenuAuthLinks.classList.remove('hidden');
                userInfo.classList.add('hidden');
                document.getElementById('user-name').textContent = '';
                document.getElementById('user-role').textContent = '';
                sideMenu.classList.remove('open');
            };

            // --- Dashboard Functions ---

            const switchView = (role) => {
                Object.values(dashboards).forEach(d => d.classList.add('hidden'));
                if (dashboards[role]) {
                    dashboards[role].classList.remove('hidden');
                }
            };
            
            const renderAllDashboards = (searchTerm = '') => {
                 if (!currentUser) return; 

                 const lowerCaseSearchTerm = searchTerm.toLowerCase();
                 const allFilteredBatches = productBatches.filter(p => 
                      p.name.toLowerCase().includes(lowerCaseSearchTerm) || 
                      p.id.toLowerCase().includes(lowerCaseSearchTerm)
                 );

                // Filter logic based on role
                if (currentUser.role === 'farmer') {
                    const farmerProducts = allFilteredBatches.filter(p => p.farmerId === currentUser.id);
                    renderProductList('farmer', farmerProducts);
                }
                
                if (currentUser.role === 'processor') {
                    const processorProducts = allFilteredBatches.filter(p => p.status === 'processed' || p.status === 'in-transit' || p.status === 'harvested'); 
                    renderProductList('processor', processorProducts);
                }
                 
                if (currentUser.role === 'retailer') {
                     const retailerProducts = allFilteredBatches.filter(p => p.status === 'at-retailer' || p.status === 'sold' || p.status === 'in-transit');
                     renderProductList('retailer', retailerProducts);
                }
                
                if (currentUser.role === 'consumer') {
                    renderProductList('consumer', allFilteredBatches);
                }
            };

            const renderProductList = (role, products) => {
                const listEl = productLists[role];
                if (!listEl) return;
                listEl.innerHTML = '';

                if (products.length === 0) {
                    listEl.innerHTML = '<p>No batches found.</p>';
                    return;
                }

                products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `
                        <div class="product-card-header">
                            <h4>${product.name}</h4>
                            <span class="status status-${product.status.replace(/\s+/g, '-').toLowerCase()}">${product.status}</span>
                        </div>
                        <p><strong>Quantity:</strong> ${product.quantity} kg</p>
                        <p><strong>Batch ID:</strong> ${product.id}</p>
                        <p><strong>Last Update:</strong> ${new Date(product.history[product.history.length-1].timestamp).toLocaleString()}</p>
                        
                        <!-- QR CODE CONTAINER FOR THE CARD -->
                        <div class="card-qr-container">
                            <canvas id="qr-${product.id}"></canvas>
                        </div>
                        
                        <div class="product-actions">
                            ${getActionsForRole(role, product)}
                        </div>
                    `;
                    listEl.appendChild(card);

                    // Generate QR code for the card
                    const trackUrl = `${window.location.href.split('#')[0]}#product=${product.id}`;
                    const qrCanvas = document.getElementById(`qr-${product.id}`);
                    if (qrCanvas) {
                        new QRious({
                            element: qrCanvas,
                            value: trackUrl,
                            size: 100, 
                            padding: 5,
                            background: 'white',
                            foreground: 'black'
                        });
                    }
                });
            };

            const getActionsForRole = (role, product) => {
                // All roles can view the journey
                let actions = `<button class="scan-btn" data-id="${product.id}">View Journey</button>`;
                
                if (!currentUser || currentUser.role !== role) return actions;

                // Role-specific actions
                switch(role) {
                    case 'farmer':
                        // Only the farmer who owns it can send it
                        if (product.status === 'harvested' && product.farmerId === currentUser.id) {
                            actions += `<button data-action="process" data-id="${product.id}">Send to Processor</button>`;
                        }
                        break;
                    case 'processor':
                        if (product.status === 'harvested') { 
                             actions += `<button data-action="process" data-id="${product.id}">Process Batch</button>`;
                        }
                        if (product.status === 'processed') {
                             actions += `<button data-action="ship" data-id="${product.id}">Ship to Retailer</button>`;
                        }
                        break;
                    case 'retailer':
                        if (product.status === 'in-transit') {
                            actions += `<button data-action="receive_retailer" data-id="${product.id}">Receive at Store</button>`;
                        }
                        if(product.status === 'at-retailer'){
                             actions += `<button data-action="sell" data-id="${product.id}">Mark as Sold</button>`;
                        }
                        break;
                }
                return actions;
            };

            const handleProductAction = (e) => {
                const target = e.target;
                const action = target.dataset.action;
                const id = target.dataset.id;

                if (target.classList.contains('scan-btn')) {
                    showTrackingModal(id);
                    return;
                }

                if (!action || !id || !currentUser) return;
                
                const product = productBatches.find(p => p.id === id);
                if (!product) return;
                
                let newStatus = '';
                let newHistoryEntry = { 
                    by: `${currentUser.name} (${currentUser.role})`, 
                    timestamp: new Date().toISOString() 
                };

                // Logic for state transitions
                if (action === 'process' && (product.status === 'harvested') && (currentUser.role === 'farmer' || currentUser.role === 'processor')) {
                    newStatus = 'processed';
                    newHistoryEntry.status = 'Processed';
                    newHistoryEntry.location = LOCATIONS.PUNE_HUB; 
                    product.status = newStatus;
                    product.history.push(newHistoryEntry);
                } else if (action === 'ship' && product.status === 'processed' && currentUser.role === 'processor') {
                    newStatus = 'in-transit';
                    newHistoryEntry.status = 'Shipped by Processor';
                    newHistoryEntry.location = product.history[product.history.length - 1].location; 
                    product.status = newStatus;
                    product.history.push(newHistoryEntry);
                    if (!product.destination) {
                        product.destination = LOCATIONS.BANGALORE_RETAIL; 
                    }
                } else if (action === 'receive_retailer' && product.status === 'in-transit' && currentUser.role === 'retailer') {
                    newStatus = 'at-retailer';
                    newHistoryEntry.status = 'Received by Retailer';
                    newHistoryEntry.location = product.destination || LOCATIONS.BANGALORE_RETAIL; 
                    product.status = newStatus;
                    product.history.push(newHistoryEntry);
                    delete product.destination; 
                } else if (action === 'sell' && product.status === 'at-retailer' && currentUser.role === 'retailer') {
                    newStatus = 'sold';
                    newHistoryEntry.status = 'Sold';
                    newHistoryEntry.location = product.history[product.history.length - 1].location; 
                    product.status = newStatus;
                    product.history.push(newHistoryEntry);
                }

                renderAllDashboards(searchInput.value);
            };
            
            const handleAddProduct = (e) => {
                e.preventDefault();
                if (!currentUser || currentUser.role !== 'farmer') {
                    return; 
                }
                
                const name = document.getElementById('product-name').value;
                const quantity = document.getElementById('product-quantity').value;
                const harvestDate = document.getElementById('harvest-date').value;
                
                const newBatch = {
                    id: `batch-${new Date().getTime()}`,
                    farmerId: currentUser.id, // Link to current farmer
                    name: name,
                    quantity: quantity,
                    status: 'harvested',
                    history: [
                        {
                            status: 'Harvested',
                            by: `${currentUser.name} (${currentUser.role})`,
                            timestamp: new Date(harvestDate).toISOString(),
                            location: LOCATIONS.MUMBAI_FARM 
                        }
                    ]
                };
                
                productBatches.unshift(newBatch); 
                renderAllDashboards();
                addProductForm.reset();
            };
            
            // --- MODAL & MAP FUNCTIONS ---
            
            const showTrackingModal = (productId) => {
                const product = productBatches.find(p => p.id === productId);
                if (!product) return;
                
                modalTitle.textContent = `Journey of ${product.name}`;
                
                trackingTimeline.innerHTML = '';
                modalQrCodeContainer.innerHTML = '';
                
                // Clear any existing map layers and intervals
                clearMapLayers();
                
                // Ensure map is initialized and the size is correct for the modal
                initMap();
                map.invalidateSize();


                // 1. Render Timeline
                product.history.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'timeline-item';
                    li.innerHTML = `
                        <p>${item.status}</p>
                        <span>by ${item.by} at ${item.location.name}</span>
                        <span>${new Date(item.timestamp).toLocaleString()}</span>
                    `;
                    trackingTimeline.appendChild(li);
                });

                // 2. Generate QR Code (as requested)
                const trackUrl = `${window.location.href.split('#')[0]}#product=${product.id}`;
                const qrCanvasContainer = document.getElementById('modal-qr-code');
                
                const tempCanvas = document.createElement('canvas');
                qrCanvasContainer.appendChild(tempCanvas);

                new QRious({
                    element: tempCanvas,
                    value: trackUrl,
                    size: 160,
                    padding: 10,
                    background: 'white',
                    foreground: 'black'
                });

                // 3. Render Historical Map Route
                const latlngs = product.history.map(item => [item.location.lat, item.location.lng]);
                
                if (latlngs.length > 0) {
                     // Draw the path
                     historicalPolyline = L.polyline(latlngs, { color: 'var(--accent-secondary)', weight: 4, opacity: 0.8 }).addTo(map);
                    
                    // Place markers for historical steps
                    product.history.forEach((item, index) => {
                         const marker = L.marker([item.location.lat, item.location.lng], {
                             title: `${item.status} at ${item.location.name}`
                         })
                         .addTo(map)
                         .bindPopup(`<b>${index + 1}. ${item.status}</b><br>${item.location.name}`);
                         historicalMarkers.push(marker);
                    });
                     
                     // Fit map view to cover all historical points
                     map.fitBounds(historicalPolyline.getBounds().pad(0.2)); 
                } else {
                    // Fallback view if no history
                    map.setView([20.5937, 78.9629], 5); 
                }

                // 4. Implement Live Tracking (if in-transit)
                if (product.status === 'in-transit' && product.destination && latlngs.length > 0) {
                    const fromLoc = product.history[product.history.length - 1].location;
                    const toLoc = product.destination;
                    
                    // Mark the final destination
                    L.marker([toLoc.lat, toLoc.lng])
                        .addTo(map)
                        .bindPopup(`<b>Destination</b><br>${toLoc.name}`);
                    
                    let progress = 0;
                    const totalSteps = 200; // Determines simulation smoothness/duration
                    
                    // Start the simulated movement
                    liveTrackingInterval = setInterval(() => {
                        progress++;
                        // Interpolate latitude and longitude for smooth movement
                        const lat = fromLoc.lat + (toLoc.lat - fromLoc.lat) * (progress / totalSteps);
                        const lng = fromLoc.lng + (toLoc.lng - fromLoc.lng) * (progress / totalSteps);
                        
                        const currentLatLng = [lat, lng];

                        if (!liveMarker) {
                            // Create the truck marker
                            liveMarker = L.marker(currentLatLng, { icon: truckIcon }).addTo(map);
                            liveMarker.bindPopup("<b>ðŸšš In Transit!</b><br>Estimated arrival soon.").openPopup();
                        } else {
                            // Move the existing marker
                            liveMarker.setLatLng(currentLatLng);
                        }
                        
                        // Keep the map centered on the moving marker
                        map.panTo(currentLatLng);

                        if (progress >= totalSteps) {
                            clearInterval(liveTrackingInterval);
                            liveTrackingInterval = null;
                            product.status = 'at-retailer'; // Auto-update status when simulation ends
                            product.history.push({
                                status: 'Received by Retailer (Simulated)',
                                by: `System`,
                                timestamp: new Date().toISOString(),
                                location: toLoc 
                            });
                            liveMarker.bindPopup("<b>Arrived at Destination!</b>").openPopup();
                            renderAllDashboards(searchInput.value); // Refresh dashboard to show new status
                        }
                    }, 50); // 50ms refresh rate for smooth animation
                }
                
                // Show the modal
                trackingModal.classList.add('visible');
            };

            const closeTrackingModal = () => {
                trackingModal.classList.remove('visible');
                clearMapLayers(); // Clear map and interval when closing
                try {
                    window.location.hash = '';
                } catch (e) {
                    console.warn("Could not clear URL hash:", e);
                }
            };
            
            // --- Help Desk Functions ---
            
            const showHelpModal = () => {
                helpModal.classList.add('visible');
                sideMenu.classList.remove('open'); // Close side menu when opening modal
            };

            const closeHelpModal = () => {
                helpModal.classList.remove('visible');
            };

            // --- NEW Info Modal Functions ---
            
            const renderUserDirectory = () => {
                userDirectoryList.innerHTML = ''; // Clear existing content
                
                MOCK_USERS.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'user-card-directory';
                    userCard.style.cssText = 'padding: 1.2rem; border: 1px solid #eee; border-radius: 12px; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.03);';
                    
                    const roleColor = {
                        farmer: 'var(--accent-primary)',
                        processor: '#8e44ad',
                        retailer: '#d35400',
                        consumer: '#2980b9'
                    }[user.role] || 'gray';
                    
                    userCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                            <h5 style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary);">${user.name}</h5>
                            <span style="padding: 4px 10px; border-radius: 999px; font-size: 0.8rem; font-weight: 600; text-transform: capitalize; background: ${roleColor}22; color: ${roleColor};">
                                ${user.role}
                            </span>
                        </div>
                        <p style="margin-bottom: 0.5rem;">
                            <strong style="color: var(--text-secondary);">Email:</strong> 
                            <a href="mailto:${user.email}" style="color: #3498db; text-decoration: none;">${user.email}</a>
                        </p>
                        <p>
                            <strong style="color: var(--text-secondary);">Contact:</strong> 
                            <a href="tel:${user.contact}" style="color: #3498db; text-decoration: none;">${user.contact}</a>
                        </p>
                    `;
                    userDirectoryList.appendChild(userCard);
                });
            };
            
            const showInfoModal = () => {
                renderUserDirectory();
                infoModal.classList.add('visible');
                sideMenu.classList.remove('open');
            };

            const closeInfoModal = () => {
                infoModal.classList.remove('visible');
            };

            // --- URL Hash Tracking ---

            const checkUrlHash = () => {
                const hash = window.location.hash;
                if (hash && hash.startsWith('#product=')) {
                    const productId = hash.substring(9); 
                    if (productId) {
                        setTimeout(() => {
                           showTrackingModal(productId);
                        }, 100);
                    }
                }
            };
            
            // --- EVENT LISTENERS ---
            const bindEventListeners = () => {
                openMenuBtn.addEventListener('click', () => sideMenu.classList.add('open'));
                closeMenuBtn.addEventListener('click', () => sideMenu.classList.remove('open'));
                
                // Auth listeners
                loginForm.addEventListener('submit', handleLogin);
                registerForm.addEventListener('submit', handleRegister);
                logoutBtn.addEventListener('click', handleLogout);
                
                // Page navigation listeners
                goToRegisterLink.addEventListener('click', () => showPage('register'));
                goToLoginLink.addEventListener('click', () => showPage('login'));
                sideMenuLoginBtn.addEventListener('click', () => {
                    showPage('login');
                    sideMenu.classList.remove('open');
                });
                sideMenuRegisterBtn.addEventListener('click', () => {
                    showPage('register');
                    sideMenu.classList.remove('open');
                });

                // Dashboard listeners
                addProductForm.addEventListener('submit', handleAddProduct);
                
                // Modal listeners
                closeModalBtn.addEventListener('click', closeTrackingModal);
                
                // Help Desk listeners
                openHelpModalBtn.addEventListener('click', showHelpModal);
                closeHelpModalBtn.addEventListener('click', closeHelpModal);

                // NEW Info Modal listeners
                openInfoModalBtn.addEventListener('click', showInfoModal);
                closeInfoModalBtn.addEventListener('click', closeInfoModal);
                
                document.body.addEventListener('click', (e) => {
                    if (e.target.dataset.id && (e.target.dataset.action || e.target.classList.contains('scan-btn'))) {
                        handleProductAction(e);
                    }
                });
                
                window.addEventListener('hashchange', checkUrlHash);

                searchInput.addEventListener('input', (e) => {
                    renderAllDashboards(e.target.value);
                });
            };

            // --- INITIALIZE APP ---
            init();

        });
    </script>
</body>
</html>
